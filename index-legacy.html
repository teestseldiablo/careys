<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Professional property management and work tracking system">
    <title>Carey's Management System</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Syncopate:wght@400;700&family=Montserrat:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        :root {
            --primary: #020617;
            --secondary: #10b981;
            --accent: #1e293b;
            --text: #f8fafc;
            --text-muted: #64748b;
            --alert: #f43f5e;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
        }
        html, body { margin: 0; padding: 0; height: 100%; }
        body {
            font-family: 'Montserrat', sans-serif;
            background: var(--primary);
            color: var(--text);
            line-height: 1.6;
        }
        #root { height: 100%; display: flex; flex-direction: column; }
        .brand {
            font-family: 'Syncopate', sans-serif;
            text-transform: uppercase;
            letter-spacing: 3px;
            font-weight: 700;
        }
        nav {
            background: rgba(2, 6, 23, 0.95);
            padding: 15px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid var(--secondary);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        .nav-brand { flex-grow: 1; }
        .nav-brand .brand { font-size: 14px; color: white; margin: 0; }
        .nav-brand .tagline { font-size: 8px; color: var(--secondary); font-weight: 900; margin-top: 2px; }
        .nav-buttons { display: flex; gap: 8px; align-items: center; }
        nav button {
            background: none;
            border: 2px solid var(--accent);
            color: var(--text-muted);
            padding: 8px 15px;
            cursor: pointer;
            font-size: 10px;
            font-weight: 700;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        nav button:hover { border-color: var(--secondary); color: var(--secondary); }
        nav button.active {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }
        nav button.exit-btn { color: var(--alert); border-color: var(--alert); }
        nav button.exit-btn:hover { background: var(--alert); color: white; }
        .container { flex: 1; max-width: 900px; margin: 30px auto; padding: 0 20px; width: 100%; overflow-y: auto; }
        .card {
            background: linear-gradient(135deg, #0f172a 0%, #1a1f35 100%);
            margin-bottom: 20px;
            padding: 25px;
            border: 1px solid var(--accent);
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        .card:hover { border-color: var(--secondary); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1); }
        .card.highlight { border-left: 5px solid var(--secondary); }
        .card-header { display: flex; justify-content: space-between; align-items: start; }
        .card-title { margin: 0 0 10px 0; font-size: 16px; color: var(--secondary); }
        .card-meta { font-size: 12px; color: var(--text-muted); }
        .card-body { margin-top: 15px; }
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--secondary);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        .stat-value { font-size: 28px; font-weight: 900; color: var(--secondary); margin: 10px 0; }
        .stat-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; }
        .btn-main {
            background: var(--secondary);
            color: white;
            border: none;
            width: 100%;
            padding: 12px 20px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 11px;
            cursor: pointer;
            border-radius: 4px;
            margin-top: 10px;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn-main:hover { background: #0d9668; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
        .btn-secondary {
            background: none;
            border: 2px solid var(--accent);
            color: var(--text-muted);
            width: 100%;
            padding: 10px 20px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 11px;
            cursor: pointer;
            border-radius: 4px;
            margin-top: 10px;
            transition: all 0.2s ease;
        }
        .btn-secondary:hover { border-color: var(--secondary); color: var(--secondary); }
        input, textarea, select {
            background: #1e293b;
            border: 1px solid var(--accent);
            color: white;
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border-radius: 4px;
            font-family: 'Montserrat', sans-serif;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.1);
        }
        textarea { resize: vertical; min-height: 100px; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-weight: 700; font-size: 12px; margin-bottom: 8px; text-transform: uppercase; }
        .media-thumb {
            height: 120px;
            width: 120px;
            object-fit: cover;
            margin-top: 15px;
            margin-right: 10px;
            border: 2px solid var(--accent);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .media-thumb:hover { border-color: var(--secondary); }
        .media-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .back-link {
            background: none;
            border: none;
            color: var(--secondary);
            cursor: pointer;
            margin-bottom: 20px;
            font-weight: 700;
            font-size: 12px;
            padding: 0;
            transition: all 0.2s ease;
        }
        .back-link:hover { transform: translateX(-4px); }
        .form-container { background: none; }
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        .login-form {
            background: linear-gradient(135deg, #0f172a 0%, #1a1f35 100%);
            border: 2px solid var(--secondary);
            border-radius: 8px;
            padding: 50px 40px;
            text-align: center;
            width: 100%;
            max-width: 350px;
        }
        .login-form .brand { font-size: 32px; margin-bottom: 30px; display: block; }
        .login-form input { text-align: center; font-size: 18px; margin: 20px 0; }
        .error-message { color: var(--alert); font-size: 12px; margin: 10px 0; text-align: center; }
        .success-message { color: var(--success); font-size: 12px; margin: 10px 0; text-align: center; }
        .property-list { margin-top: 20px; }
        .log-list { margin-top: 20px; }
        @media (max-width: 768px) {
            nav { flex-direction: column; gap: 15px; }
            .nav-buttons { width: 100%; flex-wrap: wrap; justify-content: center; }
            .stats-row { grid-template-columns: 1fr; }
            .container { margin: 20px auto; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const API_BASE = "http://localhost:5001";

        function App() {
            const [user, setUser] = useState(() => sessionStorage.getItem('userName'));
            const [view, setView] = useState('dashboard');
            const [activeProperty, setActiveProperty] = useState(null);
            const [logs, setLogs] = useState([]);
            const [properties, setProperties] = useState([]);
            const [error, setError] = useState('');

            const refreshData = async () => {
                if (!user) return;
                try {
                    setError('');
                    const [logsRes, propsRes] = await Promise.all([
                        fetch(`${API_BASE}/reports`),
                        fetch(`${API_BASE}/properties`)
                    ]);

                    if (!logsRes.ok || !propsRes.ok) throw new Error('Failed to fetch data');

                    const logsData = await logsRes.json();
                    const propsData = await propsRes.json();

                    setLogs(Array.isArray(logsData) ? logsData : []);
                    setProperties(Array.isArray(propsData) ? propsData : []);
                } catch (e) {
                    setError('Failed to sync data. Please check your connection.');
                    console.error('Sync error:', e);
                }
            };

            useEffect(() => {
                refreshData();
                const interval = setInterval(refreshData, 30000);
                return () => clearInterval(interval);
            }, [user]);

            if (!user) {
                return <Login onLogin={(name) => { sessionStorage.setItem('userName', name); setUser(name); }} />;
            }

            const handleLogout = () => {
                sessionStorage.clear();
                setUser(null);
                setView('dashboard');
            };

            return (
                <div style={{ display: 'flex', flexDirection: 'column', minHeight: '100vh' }}>
                    <nav>
                        <div className="nav-brand">
                            <div className="brand">Carey's Management</div>
                            <div className="tagline">Property & Work Tracking System</div>
                        </div>
                        <div className="nav-buttons">
                            <button className={view === 'dashboard' ? 'active' : ''} onClick={() => setView('dashboard')}>üìä Feed</button>
                            <button className={view === 'properties' || view === 'property-detail' ? 'active' : ''} onClick={() => setView('properties')}>üè¢ Portfolio</button>
                            <button className={view === 'input' ? 'active' : ''} onClick={() => setView('input')}>‚ûï Entry</button>
                            <button className="exit-btn" onClick={handleLogout}>‚èª Exit</button>
                        </div>
                    </nav>

                    <div className="container">
                        {error && <div className="error-message">‚ö†Ô∏è {error}</div>}
                        {view === 'dashboard' && <DashboardView logs={logs} properties={properties} />}
                        {view === 'properties' && <PortfolioView properties={properties} onSelect={(p) => { setActiveProperty(p); setView('property-detail'); }} onRefresh={refreshData} />}
                        {view === 'property-detail' && activeProperty && <PropertyDetailView property={activeProperty} logs={logs} onBack={() => setView('properties')} />}
                        {view === 'input' && <EntryForm user={user} properties={properties} onSuccess={() => { setView('dashboard'); refreshData(); }} />}
                    </div>
                </div>
            );
        }

        function DashboardView({ logs, properties }) {
            const totalSpent = logs.reduce((sum, log) => {
                const amount = parseFloat(log.total_expenses?.replace(/[$,]/g, '') || 0);
                return sum + amount;
            }, 0);

            return (
                <div>
                    <div className="stats-row">
                        <div className="stat-card">
                            <div className="stat-label">Total Investment</div>
                            <div className="stat-value">${totalSpent.toLocaleString('en-US', { maximumFractionDigits: 2 })}</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-label">Total Reports</div>
                            <div className="stat-value">{logs.length}</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-label">Properties</div>
                            <div className="stat-value">{properties.length}</div>
                        </div>
                    </div>

                    <div className="log-list">
                        {logs.length === 0 ? (
                            <div className="card"><p style={{ color: 'var(--text-muted)', textAlign: 'center' }}>No reports yet</p></div>
                        ) : (
                            logs.map(log => <LogCard key={log.id} log={log} />)
                        )}
                    </div>
                </div>
            );
        }

        function LogCard({ log }) {
            const createdDate = new Date(log.created_at);
            const isRecent = (Date.now() - createdDate.getTime()) < 86400000;

            return (
                <div className={`card ${isRecent ? 'highlight' : ''}`}>
                    <div className="card-header">
                        <div>
                            <h3 className="card-title">{log.subject}</h3>
                            <div className="card-meta">
                                {createdDate.toLocaleString()} ‚Ä¢ {log.employee_name}
                            </div>
                        </div>
                        <div style={{ fontSize: '20px', fontWeight: '900', color: 'var(--secondary)' }}>
                            {log.total_expenses}
                        </div>
                    </div>
                    <div className="card-body">
                        <p style={{ margin: '10px 0', lineHeight: '1.6' }}>{log.work_summary}</p>
                        {log.media_urls && log.media_urls.length > 0 && (
                            <div className="media-container">
                                {log.media_urls.map((url, i) => (
                                    <img key={i} src={`${API_BASE}${url}`} className="media-thumb" alt="Report media" />
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function PortfolioView({ properties, onSelect, onRefresh }) {
            const [showAdd, setShowAdd] = useState(false);
            const [formData, setFormData] = useState({ street: '', city: '', state: '', zip: '', name: '' });
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    const response = await fetch(`${API_BASE}/properties`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });

                    if (!response.ok) throw new Error('Failed to create property');

                    setFormData({ street: '', city: '', state: '', zip: '', name: '' });
                    setShowAdd(false);
                    onRefresh();
                } catch (e) {
                    alert('Error creating property: ' + e.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div>
                    <button className="btn-main" onClick={() => setShowAdd(!showAdd)}>
                        {showAdd ? '‚úï Cancel' : '+ Add New Property'}
                    </button>

                    {showAdd && (
                        <form className="card form-container" onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label>Street Address</label>
                                <input placeholder="123 Main Street" value={formData.street} onChange={e => setFormData({...formData, street: e.target.value})} required />
                            </div>
                            <div className="form-group">
                                <label>City</label>
                                <input placeholder="Springfield" value={formData.city} onChange={e => setFormData({...formData, city: e.target.value})} required />
                            </div>
                            <div className="form-group" style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
                                <div>
                                    <label>State</label>
                                    <input placeholder="IL" value={formData.state} onChange={e => setFormData({...formData, state: e.target.value})} maxLength="2" required />
                                </div>
                                <div>
                                    <label>ZIP Code</label>
                                    <input placeholder="62701" value={formData.zip} onChange={e => setFormData({...formData, zip: e.target.value})} required />
                                </div>
                            </div>
                            <div className="form-group">
                                <label>Nickname (Optional)</label>
                                <input placeholder="Downtown Location" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} />
                            </div>
                            <button type="submit" className="btn-main" disabled={loading}>{loading ? 'Saving...' : 'Save Property'}</button>
                        </form>
                    )}

                    <div className="property-list">
                        {properties.length === 0 ? (
                            <div className="card"><p style={{ color: 'var(--text-muted)', textAlign: 'center' }}>No properties yet. Create one to get started.</p></div>
                        ) : (
                            properties.map(p => (
                                <div key={p.id} className="card" onClick={() => onSelect(p)} style={{ cursor: 'pointer' }}>
                                    <h3 className="card-title">{p.property_name || p.address_street}</h3>
                                    <p style={{ margin: 0, color: 'var(--text-muted)', fontSize: '12px' }}>
                                        üìç {p.address_street}, {p.city}, {p.state} {p.zip_code}
                                    </p>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );
        }

        function PropertyDetailView({ property, logs, onBack }) {
            const [stats, setStats] = useState({ total_spent: 0, total_interventions: 0 });
            const propertyLogs = logs.filter(l => l.property_id === property.id);

            useEffect(() => {
                fetch(`${API_BASE}/properties/stats/${property.id}`)
                    .then(res => res.json())
                    .then(data => setStats(data));
            }, [property.id]);

            return (
                <div>
                    <button className="back-link" onClick={onBack}>‚Üê Back to Portfolio</button>

                    <div className="card highlight">
                        <h1 className="brand" style={{ margin: 0, fontSize: '24px' }}>{property.property_name || property.address_street}</h1>
                        <p style={{ color: 'var(--text-muted)', margin: '10px 0 0 0' }}>
                            {property.address_street}, {property.city}, {property.state} {property.zip_code}
                        </p>

                        <div className="stats-row" style={{ marginTop: '20px' }}>
                            <div className="stat-card">
                                <div className="stat-label">Total Investment</div>
                                <div className="stat-value">${stats.total_spent.toLocaleString('en-US', { maximumFractionDigits: 2 })}</div>
                            </div>
                            <div className="stat-card">
                                <div className="stat-label">Work Orders</div>
                                <div className="stat-value">{stats.total_interventions}</div>
                            </div>
                        </div>
                    </div>

                    {propertyLogs.length === 0 ? (
                        <div className="card"><p style={{ color: 'var(--text-muted)', textAlign: 'center' }}>No reports for this property</p></div>
                    ) : (
                        propertyLogs.map(log => <LogCard key={log.id} log={log} />)
                    )}
                </div>
            );
        }

        function EntryForm({ user, properties, onSuccess }) {
            const [formData, setFormData] = useState({
                subject: '',
                cost: '',
                note: '',
                propertyId: '',
                files: []
            });
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);

                try {
                    const formDataObj = new FormData();
                    formDataObj.append('subject', formData.subject);
                    formDataObj.append('total_expenses', formData.cost);
                    formDataObj.append('work_summary', formData.note);
                    formDataObj.append('employee_name', user);
                    formDataObj.append('property_id', formData.propertyId);

                    if (formData.files.length > 0) {
                        Array.from(formData.files).forEach(file => {
                            formDataObj.append('media', file);
                        });
                    }

                    const response = await fetch(`${API_BASE}/report`, {
                        method: 'POST',
                        body: formDataObj
                    });

                    if (!response.ok) throw new Error('Failed to save report');

                    setFormData({ subject: '', cost: '', note: '', propertyId: '', files: [] });
                    onSuccess();
                } catch (e) {
                    alert('Error saving report: ' + e.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <form className="card form-container" onSubmit={handleSubmit}>
                    <div className="form-group">
                        <label>Property</label>
                        <select value={formData.propertyId} onChange={e => setFormData({...formData, propertyId: e.target.value})} required>
                            <option value="">Select a property...</option>
                            {properties.map(p => <option key={p.id} value={p.id}>{p.property_name || p.address_street}</option>)}
                        </select>
                    </div>

                    <div className="form-group">
                        <label>Subject</label>
                        <input placeholder="What was completed?" value={formData.subject} onChange={e => setFormData({...formData, subject: e.target.value})} required />
                    </div>

                    <div className="form-group">
                        <label>Cost ($)</label>
                        <input type="number" placeholder="0.00" step="0.01" min="0" value={formData.cost} onChange={e => setFormData({...formData, cost: e.target.value})} required />
                    </div>

                    <div className="form-group">
                        <label>Work Details</label>
                        <textarea placeholder="Describe the work completed..." value={formData.note} onChange={e => setFormData({...formData, note: e.target.value})} required />
                    </div>

                    <div className="form-group">
                        <label>Attach Photos (Optional)</label>
                        <input type="file" multiple accept="image/*" onChange={e => setFormData({...formData, files: e.target.files})} />
                        {formData.files.length > 0 && <p style={{ fontSize: '12px', color: 'var(--success)' }}>‚úì {formData.files.length} file(s) selected</p>}
                    </div>

                    <button type="submit" className="btn-main" disabled={loading}>{loading ? 'Saving...' : 'Save Report'}</button>
                </form>
            );
        }

        function Login({ onLogin }) {
            const [pin, setPin] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');

                try {
                    const response = await fetch(`${API_BASE}/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ pin })
                    });

                    if (!response.ok) {
                        setError('Invalid PIN. Please try again.');
                        return;
                    }

                    const data = await response.json();
                    onLogin(data.name);
                } catch (e) {
                    setError('Connection error. Please try again.');
                    console.error('Login error:', e);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="login-container">
                    <form className="login-form" onSubmit={handleSubmit}>
                        <span className="brand">Carey's</span>
                        <p style={{ color: 'var(--text-muted)', fontSize: '12px', marginBottom: '30px' }}>Management System</p>

                        <input
                            type="password"
                            placeholder="Enter PIN"
                            value={pin}
                            onChange={e => setPin(e.target.value)}
                            disabled={loading}
                            autoFocus
                        />

                        {error && <div className="error-message">{error}</div>}

                        <button type="submit" className="btn-main" disabled={loading}>
                            {loading ? 'Authorizing...' : 'Enter System'}
                        </button>

                        <p style={{ fontSize: '10px', color: 'var(--text-muted)', marginTop: '20px' }}>
                            Demo PINs: 1234 or 5678
                        </p>
                    </form>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>